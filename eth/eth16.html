<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>区块链学习笔记</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="哔哩哔哩 —— 肖臻公开课《区块链技术与应用》学习笔记">
    
    <link rel="preload" href="/coin-notes/assets/css/0.styles.1213c4b0.css" as="style"><link rel="preload" href="/coin-notes/assets/js/app.3ac0d405.js" as="script"><link rel="preload" href="/coin-notes/assets/js/2.05c3ac16.js" as="script"><link rel="preload" href="/coin-notes/assets/js/5.865faee2.js" as="script"><link rel="prefetch" href="/coin-notes/assets/js/10.c50c7f3a.js"><link rel="prefetch" href="/coin-notes/assets/js/11.a7331f9e.js"><link rel="prefetch" href="/coin-notes/assets/js/12.b18c528d.js"><link rel="prefetch" href="/coin-notes/assets/js/13.1a5b2c4b.js"><link rel="prefetch" href="/coin-notes/assets/js/14.279786df.js"><link rel="prefetch" href="/coin-notes/assets/js/15.ede2ab4d.js"><link rel="prefetch" href="/coin-notes/assets/js/16.e310b41c.js"><link rel="prefetch" href="/coin-notes/assets/js/17.ec2950cf.js"><link rel="prefetch" href="/coin-notes/assets/js/18.c0fe37fb.js"><link rel="prefetch" href="/coin-notes/assets/js/19.4ad411cf.js"><link rel="prefetch" href="/coin-notes/assets/js/20.f841a794.js"><link rel="prefetch" href="/coin-notes/assets/js/21.b8a35657.js"><link rel="prefetch" href="/coin-notes/assets/js/22.01c56d62.js"><link rel="prefetch" href="/coin-notes/assets/js/23.0b0d06bb.js"><link rel="prefetch" href="/coin-notes/assets/js/24.32856ccc.js"><link rel="prefetch" href="/coin-notes/assets/js/25.a0734032.js"><link rel="prefetch" href="/coin-notes/assets/js/26.770c76ac.js"><link rel="prefetch" href="/coin-notes/assets/js/27.0533c371.js"><link rel="prefetch" href="/coin-notes/assets/js/28.f21df515.js"><link rel="prefetch" href="/coin-notes/assets/js/29.f93df642.js"><link rel="prefetch" href="/coin-notes/assets/js/3.67cf15e5.js"><link rel="prefetch" href="/coin-notes/assets/js/30.c8a5a37b.js"><link rel="prefetch" href="/coin-notes/assets/js/31.b1b80530.js"><link rel="prefetch" href="/coin-notes/assets/js/32.476c0b7b.js"><link rel="prefetch" href="/coin-notes/assets/js/33.a5c1f03d.js"><link rel="prefetch" href="/coin-notes/assets/js/34.45b30bbc.js"><link rel="prefetch" href="/coin-notes/assets/js/4.cb043221.js"><link rel="prefetch" href="/coin-notes/assets/js/6.e5025f99.js"><link rel="prefetch" href="/coin-notes/assets/js/7.dab81bed.js"><link rel="prefetch" href="/coin-notes/assets/js/8.4c09a35d.js"><link rel="prefetch" href="/coin-notes/assets/js/9.bc389121.js">
    <link rel="stylesheet" href="/coin-notes/assets/css/0.styles.1213c4b0.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/coin-notes/" class="home-link router-link-active"><!----> <span class="site-name">区块链学习笔记</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/coin-notes/overview01.html" class="nav-link">
  👉 学习笔记
</a></div><div class="nav-item"><a href="https://github.com/ok-james/coin-notes" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/coin-notes/overview01.html" class="nav-link">
  👉 学习笔记
</a></div><div class="nav-item"><a href="https://github.com/ok-james/coin-notes" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/coin-notes/overview01.html" class="sidebar-link">01 - 课程简介</a></li><li><section class="sidebar-group collapsable depth-0"><a href="/coin-notes/btc/btc02" class="sidebar-heading clickable"><span>BTC</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/coin-notes/eth/eth14" class="sidebar-heading clickable open"><span>ETH</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/coin-notes/eth/eth14.html" class="sidebar-link">14 - ETH-以太坊概述</a></li><li><a href="/coin-notes/eth/eth15.html" class="sidebar-link">15 - ETH-账户</a></li><li><a href="/coin-notes/eth/eth16.html" aria-current="page" class="active sidebar-link">16 - ETH-状态树</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/coin-notes/eth/eth16.html#数据结构的讨论" class="sidebar-link">数据结构的讨论</a></li><li class="sidebar-sub-header"><a href="/coin-notes/eth/eth16.html#以太坊-block-header-的结构" class="sidebar-link">以太坊 Block Header 的结构</a></li><li class="sidebar-sub-header"><a href="/coin-notes/eth/eth16.html#以太坊区块的结构" class="sidebar-link">以太坊区块的结构</a></li><li class="sidebar-sub-header"><a href="/coin-notes/eth/eth16.html#状态树中值的存储" class="sidebar-link">状态树中值的存储</a></li></ul></li><li><a href="/coin-notes/eth/eth17.html" class="sidebar-link">17 - ETH-交易树和收据树</a></li><li><a href="/coin-notes/eth/eth18.html" class="sidebar-link">18 - ETH-GHOST</a></li><li><a href="/coin-notes/eth/eth19.html" class="sidebar-link">19 - ETH-挖矿算法 ethash</a></li><li><a href="/coin-notes/eth/eth20.html" class="sidebar-link">20 - ETH-难度调整</a></li><li><a href="/coin-notes/eth/eth21.html" class="sidebar-link">21 - ETH-权益证明</a></li><li><a href="/coin-notes/eth/eth22.html" class="sidebar-link">22 - ETH-智能合约</a></li><li><a href="/coin-notes/eth/eth23.html" class="sidebar-link">23 - ETH-TheDAO</a></li><li><a href="/coin-notes/eth/eth24.html" class="sidebar-link">24 - ETH-反思</a></li><li><a href="/coin-notes/eth/eth25.html" class="sidebar-link">25 - ETH-美链</a></li></ul></section></li><li><a href="/coin-notes/summary26.html" class="sidebar-link">26 - 总结</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><p>这一节主要讲解 ETH 是通过怎样的数据结构来存储账户信息的，包括余额、交易次数等。本质上需要存储的是从账户地址到账户状态的映射（ addr —&gt; state）。</p> <p>在 ETH 中，账户地址是 160 bits 的，一般表示成一个 40 位的 16 进制的数。</p> <p>在比特币中，每个区块都对应着一个梅克尔树形式的交易树，并且会在块头中存储该梅克尔树的根哈希值。</p> <p>而在以太坊中，每个区块都对应着三棵树，分别是 <code>状态树</code> 、 <code>交易树</code> 和 <code>收据树</code> ，在块头中，有三个字段分别存储着这三棵树的根哈希值。</p> <p>而这一小节，主要讲解 <code>状态树</code> ，用来存储地址到状态的映射的树。</p> <h2 id="数据结构的讨论"><a href="#数据结构的讨论" class="header-anchor">#</a> 数据结构的讨论</h2> <p>存储 <code>状态树</code> 的数据结构需要满足如下要求：</p> <ol><li>增、改、查的效率要高</li> <li>能够方便的计算所有账户的根哈希值</li> <li>节省存储空间，可以在连续的区块之间共享未修改的账户状态，也就是说，这个数据结构必须稳定，稳定的意思是，即使账户的状态修改，对于整个数据结构的结构来说，也没有影响。</li> <li>能够保证 <code>状态树</code> 的结构在整个网络的所有节点中都保持一致，即使节点之间没有互相同步过这个结构。</li></ol> <p>有如下几个选择：</p> <h3 id="哈希表"><a href="#哈希表" class="header-anchor">#</a> 哈希表</h3> <p>主要的问题是一旦一个区块内的所有交易和合约都执行完以后，需要根据最新的哈希表重新计算根哈希值。</p> <p>个人疑问：是不是如果能够记录具体是哪个账户发生了变化，也不需要重新计算整个 <code>状态树</code> ？</p> <p>个人理解：与接下来讨论的 <code>Modified MPT</code> 的方式进行比较后，我觉得，这种方式真正不好的地方是，无法在两个连续的区块之间重用未修改的账户状态，因为一旦账户的状态修改后，就可能跑到哈希表的另一个位置上，也就是说，前后两个区块的哈希表的结构可能会差别很大，这样就需要每个区块都保存一个所有账户的副本。</p> <p>而对于 <code>Modified MPT</code> 结构来说，连续两个区块的结构都不会有大的改变，只有新增账户时，结构才会发生变化，而且，这不影响已有账户的结构。注意，我说的是结构。这样，就可以很方便的重用之前未修改的账户状态，而只需要在当前区块中记录已修改的账户即可。</p> <h3 id="梅克尔树"><a href="#梅克尔树" class="header-anchor">#</a> 梅克尔树</h3> <p>如果直接使用梅克尔树的结构存储账户，实际上就是用数组结构来存储账户。</p> <h4 id="如果是未排序的数组"><a href="#如果是未排序的数组" class="header-anchor">#</a> 如果是未排序的数组</h4> <p>如果是未排序的数组，那么查的效率就会很慢。</p> <p>老师在视频中还提出一个这种方式的问题，就是，在不同的节点之间，账户在数组中的顺序可能是不同的，从而无法在所有节点中保持唯一的一个状态树。</p> <p>我不太认同老师的说法，理由如下：一旦确定一个新区块以后，该区块需要传播给所有其他节点，其他节点收到该区块后，需要执行该区块内的交易以及合约调用。该区块内所有交易以及合约调用的顺序都是相同的，那么，节点在执行这些交易与合约时，顺序应该也是相同的，假设遇到一个新账户，那么只需要直接放到数组的末尾就可以，理论上来说，在所有节点之间，该数组的状态是相同的。</p> <p>所以，我认为，最严重的问题还是查的效率太慢了，同时造成改的效率也慢。</p> <h4 id="如果是已排序的数组"><a href="#如果是已排序的数组" class="header-anchor">#</a> 如果是已排序的数组</h4> <p>如果是已排序的数组，查找的效率确实能快一点，但是新增的效率就会慢得多，总得来说，增、改、查的效率都比较慢，因为理论上来说，账户的总数量是 2^160 ，在这样的数量级下，这样的效率很明显是无法接受的。</p> <p>而且，一旦新增数据，该数据后的所有账户都要重新计算一次哈希值。</p> <h3 id="modify-mpt"><a href="#modify-mpt" class="header-anchor">#</a> Modify MPT</h3> <p>在以太坊中，使用的数据结构是 <code>Modified MPT</code> ，要理解这个结构，首先要理解接下来的几个结构：</p> <h4 id="trie"><a href="#trie" class="header-anchor">#</a> trie</h4> <img src="/coin-notes/assets/img/trie.8e031578.png" alt="trie" width="300px"> <p>这就是一个 trie 的结构，其具有的特点：</p> <ol><li>在 trie 中，每个节点的分支数目取决于这个 key 值里每个元素的取值范围，以上面的例子为例，假设英文单词都是小写，那么一个字母的位置最多有 26 种可能性，所以 trie 中一个节点之后的分支，最多有 26 个。而对于以太坊的地址来说，由于是 16 进制的数，所以每个位置的取值范围是 0 ~ f ，一共 17 个；</li> <li>trie 的查找效率取决于 key 的长度，key 越长，需要查找访问内存的次数就越多，在以太坊中，所有的 key 都是一样长的，都是 40 位；</li> <li>不会出现碰撞，只要地址不同，就肯定可以映射到树中两个不同的分支，而之前提到的哈希表的方式，是有可能出现哈希碰撞的；</li> <li>给定一组输入，不论以何种顺序插入到 trie 中，最终构成的 trie 是同一棵树；</li> <li>更新的局部性是很好的，我觉得跟我之前提到的稳定性有相似之处。</li></ol> <p>缺点：</p> <p>存储有点浪费，对于一脉单传的情况，可以进行合并</p> <h4 id="patricia-tree"><a href="#patricia-tree" class="header-anchor">#</a> patricia tree</h4> <p>对 trie 进行路径压缩后的树，以上面的 trie 为例：</p> <img src="/coin-notes/assets/img/patricia_tree.f29e83e0.png" alt="patricia tree" width="400px"> <p>需要注意的是，如果插入一个新单词，那么之前压缩的部分可能需要扩展开。</p> <h4 id="mpt-merkle-patricia-tree"><a href="#mpt-merkle-patricia-tree" class="header-anchor">#</a> MPT Merkle Patricia Tree</h4> <p>MPT 与 patricia tree 的区别是，在 MPT 中，父节点是通过哈希指针指向下一个节点的。</p> <p>这样，从根节点开始，就有多条通过哈希指针连接的节点的路径，而这个根节点本身计算出的哈希值就作为块头中 <code>状态树</code> 的哈希值。</p> <p>在块头中保存 <code>状态树</code> 的根哈希值，有如下几个作用：</p> <ol><li>防篡改</li> <li>merkle proof ：证明一个账户的余额。将要检查的账户所在路径的所有节点都发送给轻节点，这样轻节点就可以验证账户的状态了。</li> <li>可以证明一个账户不存在</li></ol> <h4 id="modified-mpt"><a href="#modified-mpt" class="header-anchor">#</a> Modified MPT</h4> <p><code>Modified MPT</code> 是以太坊中真正使用的 <code>状态树</code> 的结构，如下图所示：</p> <p><img src="/coin-notes/assets/img/modified_MPT.e0512e9b.png" alt="Merkle tree"></p> <p>注：为了方便绘图与讨论，这里用的地址只有 7 位。正常情况下有 40 位。</p> <p>在上图中，节点与节点之间的连接是通过哈希指针实现的，也就是说，在 <code>Extension Node</code> 的 <code>next node</code> 字段内以及 <code>Branch Node</code> 节点的字段内存储的都是子节点的哈希值。</p> <p><code>Extension Node</code> ：如果这个路径出现了路径压缩，那么就会有一个 <code>Extension Node</code> 。</p> <p>另外，由图可知，根节点会取一个根哈希值，然后存储在 <code>Block Header</code> 中。</p> <p>每次发布一个新的区块的时候， <code>状态树</code> 中有一些节点的值会发生变化，这些变化不是在原处修改，而是新建一些分支，原来的状态会保留下来，</p> <p><img src="/coin-notes/assets/img/saved_MPT.def4bdb0.png" alt="Merkle tree"></p> <p>上面的例子中有两个连续的区块。由上图可知，虽然每个区块各有一个 <code>状态树</code> ，但是大部分的节点是共享的，只有那些发生改变的节点，才需要新建一个分支。上图中，黄色背景的是节点。</p> <p>另外，由上图也可知，合约账户中的存储（Storage）也是通过 MPT 的方式进行存储的，Storage 用于存储合约中变量的取值，本质上也是一个 (key, value) 的映射，所以也可以通过 MPT 进行存储。</p> <p><strong>问题：为什么要在每个区块中都保存一颗 <code>状态树</code> ？</strong></p> <p>为了回滚区块。</p> <p>在以太坊中，由于每 15s 左右就会产生一个区块，所以发生分叉是很常见的情况。如果不是每个区块都关联一颗 <code>状态树</code> ，那么要回滚区块的话，就需要回滚当前区块产生的所有操作，但是由于以太坊中存在智能合约，这个合约对应的编程语言是图灵完备的，一旦执行完毕后，就几乎不可能通过反向操作回到最初的状态，所以，每个区块都需要关联一颗 <code>状态树</code> 。</p> <h2 id="以太坊-block-header-的结构"><a href="#以太坊-block-header-的结构" class="header-anchor">#</a> 以太坊 Block Header 的结构</h2> <table><thead><tr><th>字段</th> <th>含义</th></tr></thead> <tbody><tr><td>ParentHash</td> <td>父块的哈希，也就是前一个区块的哈希值</td></tr> <tr><td>UncleHash</td> <td>叔块的哈希</td></tr> <tr><td>Coinbase</td> <td>挖出该区块的矿工的账户地址</td></tr> <tr><td>Root</td> <td>状态树的哈希值</td></tr> <tr><td>TxHash</td> <td>交易树的哈希值</td></tr> <tr><td>ReceiptHash</td> <td>收据树的哈希值</td></tr> <tr><td>Bloom</td> <td>与收据树是相关的，提供一个高效的查询，查找符合某种条件的交易的执行结果</td></tr> <tr><td>Difficulty</td> <td>挖矿难度</td></tr> <tr><td>GasLimit</td> <td>与汽油费 gas 相关</td></tr> <tr><td>GasUsed</td> <td>与汽油费 gas 相关</td></tr> <tr><td>Time</td> <td>区块大致的产生时间</td></tr> <tr><td>Extra</td> <td></td></tr> <tr><td>MixDigest</td> <td>根据 Nonce 经过一些计算，得到的哈希值</td></tr> <tr><td>Nonce</td> <td>随机数</td></tr></tbody></table> <h2 id="以太坊区块的结构"><a href="#以太坊区块的结构" class="header-anchor">#</a> 以太坊区块的结构</h2> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// &quot;external&quot; block encoding. used for eth protocol, etc.</span>
<span class="token keyword">type</span> extblock <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Header <span class="token operator">*</span>Header
	Txs    <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>Transaction
	Uncles <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>Header
<span class="token punctuation">}</span>
</code></pre></div><p>这是最终发布到区块链上的结构。</p> <h2 id="状态树中值的存储"><a href="#状态树中值的存储" class="header-anchor">#</a> 状态树中值的存储</h2> <p>状态树本质上是一个 (key, value) 的映射，在区块链中， value 会通过 <strong>RLP（Recursive Length Prefix）</strong> 编码序列化之后再存储。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/coin-notes/eth/eth15.html" class="prev">
        15 - ETH-账户
      </a></span> <span class="next"><a href="/coin-notes/eth/eth17.html">
        17 - ETH-交易树和收据树
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/coin-notes/assets/js/app.3ac0d405.js" defer></script><script src="/coin-notes/assets/js/2.05c3ac16.js" defer></script><script src="/coin-notes/assets/js/5.865faee2.js" defer></script>
  </body>
</html>
