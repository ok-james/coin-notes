<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>定义 | 区块链学习笔记</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="哔哩哔哩 —— 肖臻公开课《区块链技术与应用》学习笔记">
    
    <link rel="preload" href="/coin-notes/assets/css/0.styles.1213c4b0.css" as="style"><link rel="preload" href="/coin-notes/assets/js/app.3ac0d405.js" as="script"><link rel="preload" href="/coin-notes/assets/js/2.05c3ac16.js" as="script"><link rel="preload" href="/coin-notes/assets/js/4.cb043221.js" as="script"><link rel="prefetch" href="/coin-notes/assets/js/10.c50c7f3a.js"><link rel="prefetch" href="/coin-notes/assets/js/11.a7331f9e.js"><link rel="prefetch" href="/coin-notes/assets/js/12.b18c528d.js"><link rel="prefetch" href="/coin-notes/assets/js/13.1a5b2c4b.js"><link rel="prefetch" href="/coin-notes/assets/js/14.279786df.js"><link rel="prefetch" href="/coin-notes/assets/js/15.ede2ab4d.js"><link rel="prefetch" href="/coin-notes/assets/js/16.e310b41c.js"><link rel="prefetch" href="/coin-notes/assets/js/17.ec2950cf.js"><link rel="prefetch" href="/coin-notes/assets/js/18.c0fe37fb.js"><link rel="prefetch" href="/coin-notes/assets/js/19.4ad411cf.js"><link rel="prefetch" href="/coin-notes/assets/js/20.f841a794.js"><link rel="prefetch" href="/coin-notes/assets/js/21.b8a35657.js"><link rel="prefetch" href="/coin-notes/assets/js/22.01c56d62.js"><link rel="prefetch" href="/coin-notes/assets/js/23.0b0d06bb.js"><link rel="prefetch" href="/coin-notes/assets/js/24.32856ccc.js"><link rel="prefetch" href="/coin-notes/assets/js/25.a0734032.js"><link rel="prefetch" href="/coin-notes/assets/js/26.770c76ac.js"><link rel="prefetch" href="/coin-notes/assets/js/27.0533c371.js"><link rel="prefetch" href="/coin-notes/assets/js/28.f21df515.js"><link rel="prefetch" href="/coin-notes/assets/js/29.f93df642.js"><link rel="prefetch" href="/coin-notes/assets/js/3.67cf15e5.js"><link rel="prefetch" href="/coin-notes/assets/js/30.c8a5a37b.js"><link rel="prefetch" href="/coin-notes/assets/js/31.b1b80530.js"><link rel="prefetch" href="/coin-notes/assets/js/32.476c0b7b.js"><link rel="prefetch" href="/coin-notes/assets/js/33.a5c1f03d.js"><link rel="prefetch" href="/coin-notes/assets/js/34.45b30bbc.js"><link rel="prefetch" href="/coin-notes/assets/js/5.865faee2.js"><link rel="prefetch" href="/coin-notes/assets/js/6.e5025f99.js"><link rel="prefetch" href="/coin-notes/assets/js/7.dab81bed.js"><link rel="prefetch" href="/coin-notes/assets/js/8.4c09a35d.js"><link rel="prefetch" href="/coin-notes/assets/js/9.bc389121.js">
    <link rel="stylesheet" href="/coin-notes/assets/css/0.styles.1213c4b0.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/coin-notes/" class="home-link router-link-active"><!----> <span class="site-name">区块链学习笔记</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/coin-notes/overview01.html" class="nav-link">
  👉 学习笔记
</a></div><div class="nav-item"><a href="https://github.com/ok-james/coin-notes" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/coin-notes/overview01.html" class="nav-link">
  👉 学习笔记
</a></div><div class="nav-item"><a href="https://github.com/ok-james/coin-notes" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/coin-notes/overview01.html" class="sidebar-link">01 - 课程简介</a></li><li><section class="sidebar-group collapsable depth-0"><a href="/coin-notes/btc/btc02" class="sidebar-heading clickable"><span>BTC</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/coin-notes/eth/eth14" class="sidebar-heading clickable open"><span>ETH</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/coin-notes/eth/eth14.html" class="sidebar-link">14 - ETH-以太坊概述</a></li><li><a href="/coin-notes/eth/eth15.html" class="sidebar-link">15 - ETH-账户</a></li><li><a href="/coin-notes/eth/eth16.html" class="sidebar-link">16 - ETH-状态树</a></li><li><a href="/coin-notes/eth/eth17.html" class="sidebar-link">17 - ETH-交易树和收据树</a></li><li><a href="/coin-notes/eth/eth18.html" class="sidebar-link">18 - ETH-GHOST</a></li><li><a href="/coin-notes/eth/eth19.html" class="sidebar-link">19 - ETH-挖矿算法 ethash</a></li><li><a href="/coin-notes/eth/eth20.html" class="sidebar-link">20 - ETH-难度调整</a></li><li><a href="/coin-notes/eth/eth21.html" class="sidebar-link">21 - ETH-权益证明</a></li><li><a href="/coin-notes/eth/eth22.html" aria-current="page" class="active sidebar-link">22 - ETH-智能合约</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/coin-notes/eth/eth22.html#_1-直接调用" class="sidebar-link">1. 直接调用</a></li><li class="sidebar-sub-header"><a href="/coin-notes/eth/eth22.html#_2-使用-address-类型的-call-函数" class="sidebar-link">2. 使用 address 类型的 call() 函数</a></li><li class="sidebar-sub-header"><a href="/coin-notes/eth/eth22.html#_3-代理调用-delegatecall" class="sidebar-link">3. 代理调用 delegatecall()</a></li><li class="sidebar-sub-header"><a href="/coin-notes/eth/eth22.html#fallback函数" class="sidebar-link">fallback函数</a></li><li class="sidebar-sub-header"><a href="/coin-notes/eth/eth22.html#解释" class="sidebar-link">解释</a></li></ul></li><li><a href="/coin-notes/eth/eth23.html" class="sidebar-link">23 - ETH-TheDAO</a></li><li><a href="/coin-notes/eth/eth24.html" class="sidebar-link">24 - ETH-反思</a></li><li><a href="/coin-notes/eth/eth25.html" class="sidebar-link">25 - ETH-美链</a></li></ul></section></li><li><a href="/coin-notes/summary26.html" class="sidebar-link">26 - 总结</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="定义"><a href="#定义" class="header-anchor">#</a> 定义</h1> <ul><li>智能合约是运行在区块链上的一段代码，代码的逻辑定义了合约的内容</li> <li>智能合约的帐户保存了合约当前的运行状态
<ul><li>balance：当前余额</li> <li>nonce：交易次数</li> <li>code：合约代码</li> <li>storage：存储，数据结构是一棵MPT</li></ul></li> <li>Solidity 是智能合约最常用的语言，语法上与 JavaScnpt 很接近</li></ul> <h1 id="外部账户调用智能合约"><a href="#外部账户调用智能合约" class="header-anchor">#</a> 外部账户调用智能合约</h1> <p><img src="/coin-notes/assets/img/invoke_contract.3c50ea54.png" alt="invoke contract"></p> <p><code>SENDER ADDRESS</code> ：发送调用的外部账户的地址</p> <p><code>TO CONTRACT ADDRESS</code> ：被调用的合约的地址</p> <p><code>VALUE</code> ：发起调用时，转账到合约的以太币的数量</p> <p><code>GAS USED</code> ：该调用花费的汽油费</p> <p><code>GAS PRICE</code> ：单位汽油的价格</p> <p><code>GAS LIMIT</code> ：对于该交易，外部账户最多愿意支付多少汽油</p> <p><code>TX DATA</code> ：被调用的函数以及函数的参数都是在该字段中给出</p> <h1 id="一个合约调用另一个合约"><a href="#一个合约调用另一个合约" class="header-anchor">#</a> 一个合约调用另一个合约</h1> <h2 id="_1-直接调用"><a href="#_1-直接调用" class="header-anchor">#</a> 1. 直接调用</h2> <p><img src="/coin-notes/assets/img/invoke_direct.10b80be8.png" alt="invoke directly"></p> <h2 id="_2-使用-address-类型的-call-函数"><a href="#_2-使用-address-类型的-call-函数" class="header-anchor">#</a> 2. 使用 address 类型的 call() 函数</h2> <p><img src="/coin-notes/assets/img/address_call.ef4dc246.png" alt="address call"></p> <h2 id="_3-代理调用-delegatecall"><a href="#_3-代理调用-delegatecall" class="header-anchor">#</a> 3. 代理调用 delegatecall()</h2> <p><img src="/coin-notes/assets/img/delegate_call.6584dbdd.png" alt="delegate call"></p> <h1 id="特殊函数"><a href="#特殊函数" class="header-anchor">#</a> 特殊函数</h1> <h2 id="fallback函数"><a href="#fallback函数" class="header-anchor">#</a> fallback函数</h2> <p><img src="/coin-notes/assets/img/fallback_fn.b936f681.png" alt="fallback fn"></p> <h1 id="智能合约的创建和运行"><a href="#智能合约的创建和运行" class="header-anchor">#</a> 智能合约的创建和运行</h1> <ul><li>智能合约的代码写完后，要编译成 bytecode</li> <li>创建合约：外部帐户发起一个转账交易到 0x0 的地址
<ul><li>转账的金额是 0 ，但是要支付汽油费</li> <li>合约的代码放在 data 域里</li></ul></li> <li>智能合约运行在EVM (Ethereum Virtual Machine) 上</li> <li>以太坊是一个交易驱动的状态机
<ul><li>调用智能合约的交易发布到区块链上后，每个矿工都会执行这个交易，从当前状态确定性地转移到下一个状态</li></ul></li></ul> <h1 id="汽油费-gas-fee"><a href="#汽油费-gas-fee" class="header-anchor">#</a> 汽油费（gas fee）</h1> <ul><li><p>智能合约是个图灵完备的编程模型（Turing-complete Programming Model）</p> <ul><li>出现死循环怎么办？</li></ul></li> <li><p>执行合约中的指令要收取汽油费，由发起交易的人来支付</p> <p><img src="/coin-notes/assets/img/txdata_struct.33464715.png" alt="txdata struct"></p> <ul><li>AccountNonce：交易的序号，防止重放攻击</li> <li>Price：单位汽油的价格</li> <li>GasLimit：愿意支付的最大汽油量</li> <li>Recipient：收款人的地址</li> <li>Amount：转账金额，把 Amount 数量的钱转给 Recipient</li> <li>Payload：前面提到的 data 域，表示调用的函数以及函数参数</li></ul></li> <li><p>EVM 中不同指令消耗的汽油费是不一样的</p> <ul><li>简单的指令很便宜，复杂的或者需要存储状态的指令就很贵</li></ul></li></ul> <h1 id="错误处理"><a href="#错误处理" class="header-anchor">#</a> 错误处理</h1> <ul><li>智能合约中不存在自定义的 try-catch 结构</li> <li>一旦遇到异常，除特殊情况外，本次执行操作全部回滚</li> <li>可以抛出错误的语句
<ul><li><p>assert（bool condition）：如果条件不满足就抛出——用于内部错误</p></li> <li><p>require（bool condition）：如果条件不满足就抛出——用于输入或者外部组件引起的错误。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">bid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">public</span> payable <span class="token punctuation">{</span>
    <span class="token comment">// 对于能接受以太币的函数，关键字 payable 是必须的。</span>

    <span class="token comment">// 拍卖尚未结束</span>
    <span class="token function">require</span><span class="token punctuation">(</span>now <span class="token operator">&lt;=</span> auctionEnd<span class="token punctuation">)</span>
</code></pre></div></li> <li><p>revert()：终止运行并回滚状态变动。</p></li></ul></li></ul> <h1 id="嵌套调用"><a href="#嵌套调用" class="header-anchor">#</a> 嵌套调用</h1> <ul><li>智能合约的执行具有原子性：执行过程中出现错误，会导致回滚</li> <li>嵌套调用是指一个合约调用另一个合约中的函数</li> <li>嵌套调用是否会触发连锁式的回滚?
<ul><li>如果被调用的合约执行过程中发生异常,会不会导致发起调用的。这个合约也跟着一起回滚?</li> <li>有些调用方法会引起连锁式的回滚,有些则不会</li></ul></li> <li>一个合约直接向一个合约帐户里转账,没有指明调用哪个函数,仍然会引起嵌套调用</li></ul> <h1 id="block-header"><a href="#block-header" class="header-anchor">#</a> Block Header</h1> <p>块头中有两个字段与汽油费相关：</p> <p><code>GasUsed</code> ：当前区块中所有交易花费的汽油费的总和</p> <p><code>GasLimit</code> ：当前区块中能够消耗的所有汽油费的上限，用于限制单个区块中交易的数量。这个值不是固定的，而是可以在上一个区块的 <code>GasLimit</code> 的基础上上调或者下调 1/1024 。</p> <h1 id="问题与解答"><a href="#问题与解答" class="header-anchor">#</a> 问题与解答</h1> <h3 id="_1-应该是先挖矿还是先执行交易与智能合约"><a href="#_1-应该是先挖矿还是先执行交易与智能合约" class="header-anchor">#</a> 1. 应该是先挖矿还是先执行交易与智能合约？</h3> <p>应该先执行交易与智能合约，因为在块头中有 <code>状态树</code> 、 <code>交易树</code> 和 <code>收据树</code> 的三个根哈希值，所以必须先通过执行交易和智能合约，才能确定这三棵树的最终状态，从而计算出三个根哈希值，最后，再计算 nonce ，开始挖矿。</p> <h3 id="_2-由于全节点在验证区块合法性时无法得到汽油费-是否会促使全节点不对区块进行验证"><a href="#_2-由于全节点在验证区块合法性时无法得到汽油费-是否会促使全节点不对区块进行验证" class="header-anchor">#</a> 2. 由于全节点在验证区块合法性时无法得到汽油费，是否会促使全节点不对区块进行验证？</h3> <p>首先，这会危机区块链的安全，因为协议要求全节点必须独立验证区块的合法性，如果全节点不验证的话，就可能会有非法的交易存在，从而有恶意的节点才无法篡改区块链上内容。</p> <p>全节点必须验证发布的区块，因为如果不执行的话，全节点本地保存的三棵树的内容与其他节点就不一致了，从而就无法继续挖矿了，或者就算继续挖矿，得到的区块也是非法的。</p> <h3 id="_3-执行失败的交易与智能合约需要发布到区块链上吗"><a href="#_3-执行失败的交易与智能合约需要发布到区块链上吗" class="header-anchor">#</a> 3. 执行失败的交易与智能合约需要发布到区块链上吗？</h3> <p>需要，因为执行失败的交易与智能合约也需要扣除汽油费，如果不将其发布到区块链上，就无法达成扣除该账户对应汽油费的共识了，所以失败的也要发布。这样看来，发布到区块链上的交易不一定是成功执行的。</p> <h1 id="receipt-数据结构"><a href="#receipt-数据结构" class="header-anchor">#</a> Receipt 数据结构</h1> <p><img src="/coin-notes/assets/img/receipt_struct.9973ffc8.png" alt="receipt struct"></p> <p><code>Status</code> ：收据对应的交易的执行结果是怎样的。</p> <h1 id="智能合约可以获得的区块信息"><a href="#智能合约可以获得的区块信息" class="header-anchor">#</a> 智能合约可以获得的区块信息</h1> <ul><li><code>block.blockhash(uint blockNumber) returns (bytes32)</code> ：给定区块的哈希——仅对最近的256个区块有效而不包括当前区块</li> <li><code>block.coinbase (address)</code> ：挖出当前区块的矿工地址</li> <li><code>block.difficulty (uint)</code> ：当前区块难度</li> <li><code>block.gaslimit (uint)</code> ：当前区块 gas 限额</li> <li><code>block.number (uint)</code> ：当前区块号</li> <li><code>block.timestamp (uint)</code> ：自 unix epoch 起始当前区块以秒计的时间截</li></ul> <h1 id="智能合约可以获得的调用信息"><a href="#智能合约可以获得的调用信息" class="header-anchor">#</a> 智能合约可以获得的调用信息</h1> <ul><li><code>msg.data (bytes )</code> ：完整的 calldata</li> <li><code>msg.gas (uint)</code> ：剩余 gas</li> <li><code>msg.sender (address)</code> ：消息发送者(当前调用)</li> <li><code>msg.sig (bytes4)</code> ：calldata 的前 4 字节(也就是函数标识符)</li> <li><code>msg.value (uint)</code> ：随消息发送的 wei 的数量</li> <li><code>now (uint)</code> ：目前区块时间戳( <code>block.timestamp</code> )</li> <li><code>tx.gasprice (uint)</code> ：交易的 gas 价格</li> <li><code>tx.origin (address)</code> ：交易发起者(完全的调用链)</li></ul> <p>消息发送者与交易发起者的区别是：通过一个例子来说明一下，假设 A 是外部账户，调用了合约 C1 的 f1 函数， f1 函数又调用了合约 C2 的 f2 函数，那么对于 f2 来说，消息发送者是 C1 ，而交易发起者是 A 。</p> <h1 id="地址类型-address"><a href="#地址类型-address" class="header-anchor">#</a> 地址类型 address</h1> <p><img src="/coin-notes/assets/img/address_type.3fde431e.png" alt="address type"></p> <p>所有智能合约均可显式地转换成地址类型。</p> <h2 id="解释"><a href="#解释" class="header-anchor">#</a> 解释</h2> <h3 id="address-transfer-uint256-amount"><a href="#address-transfer-uint256-amount" class="header-anchor">#</a> &lt;address&gt;.transfer(uint256 amount)</h3> <p>这个函数的含义是从调用该方法的智能合约中向 <code>&lt;address&gt;</code> 这个地址转入 <code>amount</code> 数量的虚拟币。</p> <h1 id="三种发送-eth-的方式"><a href="#三种发送-eth-的方式" class="header-anchor">#</a> 三种发送 ETH 的方式</h1> <ul><li>&lt;address&gt;.transfer(uint256 amount)</li> <li>&lt;address&gt;.send(uint256 amount) returns (bool)</li> <li>&lt;address&gt;.call.value(uint256 amount)()</li></ul> <p><code>transfer</code> 和 <code>send</code> 是专门用于转账的方法， <code>transfer</code> 会导致连锁式回滚，而调用 <code>send</code> 时一旦抛出异常，不会引起连锁式回滚，而是返回 <code>false</code> 。</p> <p><code>call</code> 本身不是用于转账的，但是可以用于调用其他函数，从而可以引起转账。</p> <p>另外， <code>transfer</code> 和 <code>send</code> 在调用时，是发送固定金额的汽油费，而 <code>call</code> 在调用时，是发送剩余的所有汽油费。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/coin-notes/eth/eth21.html" class="prev">
        21 - ETH-权益证明
      </a></span> <span class="next"><a href="/coin-notes/eth/eth23.html">
        23 - ETH-TheDAO
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/coin-notes/assets/js/app.3ac0d405.js" defer></script><script src="/coin-notes/assets/js/2.05c3ac16.js" defer></script><script src="/coin-notes/assets/js/4.cb043221.js" defer></script>
  </body>
</html>
