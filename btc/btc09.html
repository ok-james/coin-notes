<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>交易结构 | 区块链学习笔记</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="哔哩哔哩 —— 肖臻公开课《区块链技术与应用》学习笔记">
    
    <link rel="preload" href="/coin-notes/assets/css/0.styles.1213c4b0.css" as="style"><link rel="preload" href="/coin-notes/assets/js/app.3ac0d405.js" as="script"><link rel="preload" href="/coin-notes/assets/js/2.05c3ac16.js" as="script"><link rel="preload" href="/coin-notes/assets/js/3.67cf15e5.js" as="script"><link rel="prefetch" href="/coin-notes/assets/js/10.c50c7f3a.js"><link rel="prefetch" href="/coin-notes/assets/js/11.a7331f9e.js"><link rel="prefetch" href="/coin-notes/assets/js/12.b18c528d.js"><link rel="prefetch" href="/coin-notes/assets/js/13.1a5b2c4b.js"><link rel="prefetch" href="/coin-notes/assets/js/14.279786df.js"><link rel="prefetch" href="/coin-notes/assets/js/15.ede2ab4d.js"><link rel="prefetch" href="/coin-notes/assets/js/16.e310b41c.js"><link rel="prefetch" href="/coin-notes/assets/js/17.ec2950cf.js"><link rel="prefetch" href="/coin-notes/assets/js/18.c0fe37fb.js"><link rel="prefetch" href="/coin-notes/assets/js/19.4ad411cf.js"><link rel="prefetch" href="/coin-notes/assets/js/20.f841a794.js"><link rel="prefetch" href="/coin-notes/assets/js/21.b8a35657.js"><link rel="prefetch" href="/coin-notes/assets/js/22.01c56d62.js"><link rel="prefetch" href="/coin-notes/assets/js/23.0b0d06bb.js"><link rel="prefetch" href="/coin-notes/assets/js/24.32856ccc.js"><link rel="prefetch" href="/coin-notes/assets/js/25.a0734032.js"><link rel="prefetch" href="/coin-notes/assets/js/26.770c76ac.js"><link rel="prefetch" href="/coin-notes/assets/js/27.0533c371.js"><link rel="prefetch" href="/coin-notes/assets/js/28.f21df515.js"><link rel="prefetch" href="/coin-notes/assets/js/29.f93df642.js"><link rel="prefetch" href="/coin-notes/assets/js/30.c8a5a37b.js"><link rel="prefetch" href="/coin-notes/assets/js/31.b1b80530.js"><link rel="prefetch" href="/coin-notes/assets/js/32.476c0b7b.js"><link rel="prefetch" href="/coin-notes/assets/js/33.a5c1f03d.js"><link rel="prefetch" href="/coin-notes/assets/js/34.45b30bbc.js"><link rel="prefetch" href="/coin-notes/assets/js/4.cb043221.js"><link rel="prefetch" href="/coin-notes/assets/js/5.865faee2.js"><link rel="prefetch" href="/coin-notes/assets/js/6.e5025f99.js"><link rel="prefetch" href="/coin-notes/assets/js/7.dab81bed.js"><link rel="prefetch" href="/coin-notes/assets/js/8.4c09a35d.js"><link rel="prefetch" href="/coin-notes/assets/js/9.bc389121.js">
    <link rel="stylesheet" href="/coin-notes/assets/css/0.styles.1213c4b0.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/coin-notes/" class="home-link router-link-active"><!----> <span class="site-name">区块链学习笔记</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/coin-notes/overview01.html" class="nav-link">
  👉 学习笔记
</a></div><div class="nav-item"><a href="https://github.com/ok-james/coin-notes" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/coin-notes/overview01.html" class="nav-link">
  👉 学习笔记
</a></div><div class="nav-item"><a href="https://github.com/ok-james/coin-notes" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/coin-notes/overview01.html" class="sidebar-link">01 - 课程简介</a></li><li><section class="sidebar-group collapsable depth-0"><a href="/coin-notes/btc/btc02" class="sidebar-heading clickable open"><span>BTC</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/coin-notes/btc/btc02.html" class="sidebar-link">02 - BTC-密码学原理</a></li><li><a href="/coin-notes/btc/btc03.html" class="sidebar-link">03 - BTC-数据结构</a></li><li><a href="/coin-notes/btc/btc04.html" class="sidebar-link">04 - BTC-协议</a></li><li><a href="/coin-notes/btc/btc05.html" class="sidebar-link">05 - BTC-实现</a></li><li><a href="/coin-notes/btc/btc06.html" class="sidebar-link">06 - BTC-网络</a></li><li><a href="/coin-notes/btc/btc07.html" class="sidebar-link">07 - BTC-挖矿难度</a></li><li><a href="/coin-notes/btc/btc08.html" class="sidebar-link">08 - BTC-挖矿</a></li><li><a href="/coin-notes/btc/btc09.html" aria-current="page" class="active sidebar-link">09 - BTC-比特币脚本</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/coin-notes/btc/btc09.html#交易结构" class="sidebar-link">交易结构</a></li><li class="sidebar-sub-header"><a href="/coin-notes/btc/btc09.html#获取链上的真实交易" class="sidebar-link">获取链上的真实交易</a></li><li class="sidebar-sub-header"><a href="/coin-notes/btc/btc09.html#交易脚本入门" class="sidebar-link">交易脚本入门</a></li><li class="sidebar-sub-header"><a href="/coin-notes/btc/btc09.html#输入输出脚本的几种形式" class="sidebar-link">输入输出脚本的几种形式</a></li></ul></li><li><a href="/coin-notes/btc/btc10.html" class="sidebar-link">10 - BTC-分叉</a></li><li><a href="/coin-notes/btc/btc11.html" class="sidebar-link">11 - BTC-问答</a></li><li><a href="/coin-notes/btc/btc12.html" class="sidebar-link">12 - BTC-匿名性</a></li><li><a href="/coin-notes/btc/btc13.html" class="sidebar-link">13 - BTC-思考</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/coin-notes/eth/eth14" class="sidebar-heading clickable"><span>ETH</span> <span class="arrow right"></span></a> <!----></section></li><li><a href="/coin-notes/summary26.html" class="sidebar-link">26 - 总结</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="交易结构"><a href="#交易结构" class="header-anchor">#</a> 交易结构</h2> <h4 id="meta-元数据结构"><a href="#meta-元数据结构" class="header-anchor">#</a> meta 元数据结构</h4> <table><thead><tr><th>字段名</th> <th>含义</th></tr></thead> <tbody><tr><td>txid</td> <td>交易的id</td></tr> <tr><td>hash</td> <td>交易的hash</td></tr> <tr><td>version</td> <td>使用的比特币协议的版本号</td></tr> <tr><td>size</td> <td>当前交易的大小</td></tr> <tr><td>locktime</td> <td>用于指定交易的生效时间，0 表示立即生效，如果是非 0 值，那么这个交易需要过一段时间才能生效</td></tr> <tr><td>vin</td> <td>交易的输入</td></tr> <tr><td>vout</td> <td>交易的输出</td></tr> <tr><td>blockhash</td> <td>这个交易所在区块的 hash</td></tr> <tr><td>confirmations</td> <td>这个交易已经有多少个确认信息</td></tr> <tr><td>time</td> <td>这个交易产生的时间</td></tr> <tr><td>blocktime</td> <td>这个区块产生的时间</td></tr></tbody></table> <p>个人声明：这些字段肯定不全是真实存储在链上的交易所拥有的字段，比如上面提到的 <em>confirmations</em> 字段就不可能存储在真实的交易中。这些字段中，有些字段是直接存储在链上的，有些需要经过链下的二次加工得到。</p> <h4 id="inputs-输入结构"><a href="#inputs-输入结构" class="header-anchor">#</a> inputs 输入结构</h4> <table><thead><tr><th>字段名</th> <th>含义</th></tr></thead> <tbody><tr><td>txid</td> <td>币的来源交易的 hash 值</td></tr> <tr><td>vout</td> <td>表示交易的第几个输出</td></tr> <tr><td>scriptSig</td> <td>输入脚本</td></tr></tbody></table> <h4 id="outputs-输出结构"><a href="#outputs-输出结构" class="header-anchor">#</a> outputs 输出结构</h4> <table><thead><tr><th>字段名</th> <th>含义</th></tr></thead> <tbody><tr><td>value</td> <td>转账的输出金额</td></tr> <tr><td>n</td> <td>序号，表示这是交易里的第几个输出</td></tr> <tr><td>scriptPubKey</td> <td>输出脚本</td></tr></tbody></table> <h2 id="获取链上的真实交易"><a href="#获取链上的真实交易" class="header-anchor">#</a> 获取链上的真实交易</h2> <p>在区块链上，交易是通过 <code>hex</code> 的形式保存的，要获取原始的 <code>hex</code> ，有多种方式，很多区块链浏览器都有查询原始交易 <code>hex</code> 的 API ，比如 <a href="https://github.com/Blockstream/esplora/blob/master/API.md" target="_blank" rel="noopener noreferrer">blockStream API<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> ：</p> <p><img src="/coin-notes/assets/img/tx_api.6106d515.png" alt="Merkle proof"></p> <p>不过，最方便的方式还是通过 <strong><a href="https://bitcoindata.science/bitcoin-raw-transaction-hex.html" target="_blank" rel="noopener noreferrer">Get Raw Transaction in Hex Format<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></strong> 这个工具直接查询，只需输入交易 hash 即可：</p> <p><img src="/coin-notes/assets/img/get_tx_raw.3583d5fc.png" alt="Merkle proof"></p> <p>得到 <code>hex</code> 后，需要将其转换为 JSON 格式，可以通过 BLOCKCYPHER 的 <a href="https://live.blockcypher.com/btc/decodetx/" target="_blank" rel="noopener noreferrer">decodetx<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 这个工具完成：</p> <p><img src="/coin-notes/assets/img/decode_tx_raw.3aa87bd0.png" alt="Merkle proof"></p> <h4 id="实例-921af728159e3019c18bbe0de9c70aa563ad27f3f562294d993a208d4fcfdd24-这个交易的原始-json"><a href="#实例-921af728159e3019c18bbe0de9c70aa563ad27f3f562294d993a208d4fcfdd24-这个交易的原始-json" class="header-anchor">#</a> 实例：921af728159e3019c18bbe0de9c70aa563ad27f3f562294d993a208d4fcfdd24 这个交易的原始 JSON</h4> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;addresses&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">&quot;1MaBFqBEfcQyXPv3fm5WAW9aQuJuKHaA3A&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;19z8LJkNXLrTv2QK5jgTncJCGUEEfpQvSr&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;1LvGTpdyeVLcLCDK2m9f7Pbh7zwhs7NYhX&quot;</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">&quot;block_height&quot;</span><span class="token operator">:</span> <span class="token number">-1</span><span class="token punctuation">,</span>
    <span class="token property">&quot;block_index&quot;</span><span class="token operator">:</span> <span class="token number">-1</span><span class="token punctuation">,</span>
    <span class="token property">&quot;confirmations&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token property">&quot;double_spend&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token property">&quot;fees&quot;</span><span class="token operator">:</span> <span class="token number">29040</span><span class="token punctuation">,</span>
    <span class="token property">&quot;hash&quot;</span><span class="token operator">:</span> <span class="token string">&quot;921af728159e3019c18bbe0de9c70aa563ad27f3f562294d993a208d4fcfdd24&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;inputs&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
            <span class="token property">&quot;addresses&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
                <span class="token string">&quot;1MaBFqBEfcQyXPv3fm5WAW9aQuJuKHaA3A&quot;</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token property">&quot;age&quot;</span><span class="token operator">:</span> <span class="token number">530654</span><span class="token punctuation">,</span>
            <span class="token property">&quot;output_index&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
            <span class="token property">&quot;output_value&quot;</span><span class="token operator">:</span> <span class="token number">76469684</span><span class="token punctuation">,</span>
            <span class="token property">&quot;prev_hash&quot;</span><span class="token operator">:</span> <span class="token string">&quot;c0cb92ca8e41070233bf965d808b0fc4bac144dab05690b17823fac3e184c57b&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;script&quot;</span><span class="token operator">:</span> <span class="token string">&quot;483045022100928496fb0d2a25e4e7c99b9c60d4d0d12fcf8974a0faffcb30119b0d385872a30220253d3d0c507e5e44e123bc28b795ab4a38bf3b205455403e77aa72d58d9e17110121022ef8d3a6dd8a7039e513acc8ecf9b094ed7e85439824a1d11920f85927cd0018&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;script_type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;pay-to-pubkey-hash&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;sequence&quot;</span><span class="token operator">:</span> <span class="token number">4294967295</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">&quot;outputs&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
            <span class="token property">&quot;addresses&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
                <span class="token string">&quot;19z8LJkNXLrTv2QK5jgTncJCGUEEfpQvSr&quot;</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token property">&quot;script&quot;</span><span class="token operator">:</span> <span class="token string">&quot;76a914628ed6567c0b9056067309f07bbea2992ecad74388ac&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;script_type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;pay-to-pubkey-hash&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;value&quot;</span><span class="token operator">:</span> <span class="token number">22684000</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            <span class="token property">&quot;addresses&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
                <span class="token string">&quot;1LvGTpdyeVLcLCDK2m9f7Pbh7zwhs7NYhX&quot;</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token property">&quot;script&quot;</span><span class="token operator">:</span> <span class="token string">&quot;76a914da7d57dfd02c6f5a9c649e891b5ac199ad012cd288ac&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;script_type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;pay-to-pubkey-hash&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;value&quot;</span><span class="token operator">:</span> <span class="token number">53756644</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">&quot;preference&quot;</span><span class="token operator">:</span> <span class="token string">&quot;high&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;received&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2022-06-25T08:50:09.602679417Z&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;relayed_by&quot;</span><span class="token operator">:</span> <span class="token string">&quot;35.172.182.94&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;size&quot;</span><span class="token operator">:</span> <span class="token number">226</span><span class="token punctuation">,</span>
    <span class="token property">&quot;total&quot;</span><span class="token operator">:</span> <span class="token number">76440644</span><span class="token punctuation">,</span>
    <span class="token property">&quot;ver&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token property">&quot;vin_sz&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token property">&quot;vout_sz&quot;</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
    <span class="token property">&quot;vsize&quot;</span><span class="token operator">:</span> <span class="token number">226</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="交易脚本入门"><a href="#交易脚本入门" class="header-anchor">#</a> 交易脚本入门</h2> <p>交易脚本的作用就是验证当前交易的合法性，该脚本是一个特别简单的堆栈脚本，没有复杂的条件语句的判断，比如 if 、 for 等。</p> <p>通过脚本验证交易时，是先取当前交易的输入脚本（input script），之后拼接上币的来源交易的输出脚本（output script），然后执行拼接后的脚本，如果最终的执行结果没有问题，验证成功，否则，验证失败，交易无效，拼接的示意图如下：</p> <p><img src="/coin-notes/assets/img/script_basic.ffe7e7f1.png" alt="Merkle proof"></p> <blockquote><p>这里再重点强调一下，输出脚本来自于币的来源（UTXO）所属的交易，而不是当前交易，一定要记住这一点。对于理解后面的内容，这一点非常重要。</p></blockquote> <h2 id="输入输出脚本的几种形式"><a href="#输入输出脚本的几种形式" class="header-anchor">#</a> 输入输出脚本的几种形式</h2> <h3 id="p2pk-pay-to-public-key"><a href="#p2pk-pay-to-public-key" class="header-anchor">#</a> P2PK（Pay to Public Key）</h3> <h4 id="算法表示形式"><a href="#算法表示形式" class="header-anchor">#</a> 算法表示形式</h4> <p><strong>input script:</strong></p> <p>PUSHDATA(Sig)</p> <p><strong>output script:</strong></p> <p>PUSHDATA(PubKey)</p> <p>CHECKSI</p> <h4 id="解释"><a href="#解释" class="header-anchor">#</a> 解释</h4> <p>算法表示形式中的 <code>PUSHDATA</code> 是将数据放到栈顶。</p> <p><code>Sig</code> 表示私钥的签名</p> <p><code>PubKey</code> 表示上面提到的私钥所对应的公钥</p> <p><code>CHECKSI</code> 方法弹出栈顶数据作为公钥，然后再弹出栈顶数据作为签名，最后用公钥来验证签名</p> <h4 id="实例"><a href="#实例" class="header-anchor">#</a> 实例</h4> <p><img src="/coin-notes/assets/img/ins_one.4853faf7.png" alt="Merkle proof"></p> <p>input的交易哈希是ea44e97271691990157559d0bdd9959e02790c34db6c006d779e82fa5aee708e</p> <p>另外，可以通过在 <a href="https://blockstream.info" target="_blank" rel="noopener noreferrer">Blockstream Explorer<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 上更直观的查看结果，如下：</p> <p><img src="/coin-notes/assets/img/ins_result_one.c39e7c20.png" alt="Merkle proof"></p> <h3 id="p2pkh-pay-to-public-key-hash"><a href="#p2pkh-pay-to-public-key-hash" class="header-anchor">#</a> P2PKH ( Pay to Public Key Hash )</h3> <h4 id="算法表示形式-2"><a href="#算法表示形式-2" class="header-anchor">#</a> 算法表示形式</h4> <p><strong>input script:</strong></p> <p>PUSHDATA(Sig)</p> <p>PUSHDATA(PubKey)</p> <p><strong>output script:</strong></p> <p>DUP</p> <p>HASH160</p> <p>PUSHDATA(PubKeyHash)</p> <p>EQUALVERIFY</p> <p>CHECKSIG</p> <p>这是最常用的指令形式。</p> <h4 id="解释-2"><a href="#解释-2" class="header-anchor">#</a> 解释</h4> <p>这个算法与上一个算法最大的不同是，这里的 <code>output script</code> 中给出的是公钥的 hash （ <code>PubKeyHash</code> ）而不是直接给出公钥，公钥是在输入脚本中给出的。</p> <p>另外，这里的主要解释上面的算法中没有提到的指令以及参数，下同。</p> <p><code>DUP</code> ：把栈顶的元素复制一次，并放到栈顶</p> <p><code>HASH160</code> ：把栈顶的元素取 hash ，然后把结果再压入栈</p> <p><code>PubKeyHash</code> ：输出脚本中提供的公钥的 hash 值</p> <p><code>EQUALVERIFY</code> ：比较栈顶的两个值是否相等</p> <h4 id="实例-2"><a href="#实例-2" class="header-anchor">#</a> 实例</h4> <p><img src="/coin-notes/assets/img/ins_two.c30beda9.png" alt="Merkle proof"></p> <p>同样可以通过在 <a href="https://blockstream.info" target="_blank" rel="noopener noreferrer">Blockstream Explorer<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 上更直观的查看结果。</p> <h3 id="p2sh-pay-to-script-hash"><a href="#p2sh-pay-to-script-hash" class="header-anchor">#</a> P2SH ( Pay to Script Hash )</h3> <h4 id="算法表示形式-3"><a href="#算法表示形式-3" class="header-anchor">#</a> 算法表示形式</h4> <p>采用 BIP16 的方案：</p> <p><strong>input script:</strong></p> <p>…</p> <p>PUSHDATA(Sig)</p> <p>…</p> <p>PUSHDATA(serialized redeemScript)</p> <p><strong>output script:</strong></p> <p>HASH160</p> <p>PUSHDATA(redeemScriptHash)</p> <p>EQUAL</p> <h4 id="解释-3"><a href="#解释-3" class="header-anchor">#</a> 解释</h4> <p>这里， <code>output script</code> 提供的不是收款人公钥的 hash ，而是一段脚本的 hash （ <code>redeemScriptHash</code> ）</p> <p>将来花费这个 UTXO 时，需要在 <code>input script</code> 中指定这段 <code>redeemScript</code> 的内容，同时还需要给出让这个脚本正常执行所需要的签名（ <code>Sig</code> ）。</p> <p><code>serialized redeemScript</code> ：序列化后的执行脚本，在执行之前，需要先反序列化</p> <p><code>redeemScriptHash</code> ：序列化后的执行脚本的 hash 值</p> <h4 id="进一步说明"><a href="#进一步说明" class="header-anchor">#</a> 进一步说明</h4> <p><code>input script</code> 要给出一些签名（数目不定）及一段 <em>序列化</em> 的 <strong>redeemScript</strong> 。验证分如下两步:</p> <p>① 验证序列化的 <strong>redeemScript</strong> 是否与 <code>output script</code> 中的哈希值匹配?</p> <p>② 反序列化并执行 <strong>redeemScript</strong> ,验证 <code>input script</code> 中给出的签名是否正确?</p> <p><strong>redeemScript</strong> 的形式</p> <p>① <code>P2PK</code> 形式</p> <p>② <code>P2PKH</code> 形式</p> <p>③ 多重签名形式</p> <h4 id="实例-3"><a href="#实例-3" class="header-anchor">#</a> 实例</h4> <p><img src="/coin-notes/assets/img/ins_three.b3160a96.png" alt="Merkle proof"></p> <p>上面的脚本所对应的流程如下：</p> <p>PUSHDATA(Sig)</p> <p>PUSHDATA(serialized redeemScript)</p> <p>HASH160</p> <p>PUSHDATA(redeemScriptHash)</p> <p>EQUAL</p> <p>PUSHDATA(PubKey)</p> <p>CHECKSIG</p> <p>需要注意一点，上面也提到了，这里再强调一下，在执行 <code>serialized redeemScript</code> 之前，需要先反序列化之后再执行，这需要每个节点自动完成。</p> <h4 id="多重签名"><a href="#多重签名" class="header-anchor">#</a> 多重签名</h4> <p>在原视频的 19:50 左右，提到 <code>P2SH</code> 在多重签名中的应用。这里对视频中老师提到的例子做一下解释。注意，这段解释需要结合原视频内容。</p> <p>老师先举了一个不再推荐使用的多重签名的方式，这种方式没有使用到 <code>P2SH</code> ，如下图所示，那这种方式的问题是什么呢？</p> <p><img src="/coin-notes/assets/img/mul_sig_old.d6fe69d4.png" alt="Merkle proof"></p> <p>最主要的问题是 <code>output script</code> 中需要提供多个 <code>pubkey</code> 以及 <code>M</code> 和 <code>N</code> 的值，这就给支付者增加了负担。</p> <p>假设有一个购物网站有五个合伙人，他们使用多重签名的方式进行收款，并且规定，需要 3 个签名才能生效。</p> <p>当一个用户 A 在这个网站购物时，A 作为支付者，需要拿到所有这五个合伙人的 <code>pubkey</code> 以及 M（3）和 N （5）的值，因为支付交易是由 A 构造的。上面截图中的交易是 A 完成支付以后，五个合伙人花费 A 支付的比特币的交易， 上图中的 <code>output script</code> 是之前 A 所创造的支付交易的输出。</p> <p>总结来说，这么复杂的 <code>output script</code> 需要支付者来构造，很不方便，所以就改成了 <code>P2SH</code> 。</p> <p>而使用 <code>P2SH</code> 后的多重签名如下：</p> <p><img src="/coin-notes/assets/img/mul_sig_new.3e54f69a.png" alt="Merkle proof"></p> <p>仍然以上面的购物网站为例，此时，支付者 A 不再需要提供 <code>pubkey</code> 、 <code>M</code> 和 <code>N</code> 等信息，而只需要提供一个脚本的 hash 值即可，所有的验证操作都在 <code>redeemScript</code> 脚本中。</p> <p>如果还是不能理解，那就说明，对于 <code>input script</code> 以及 <code>output script</code> 分别属于哪个交易没有理解清楚， <code>input script</code> 属于当前交易， <code>output script</code> 属于币的来源的交易，也就是 <code>UTXO</code> 。</p> <h4 id="使用-p2sh-实现多重签名的实际例子"><a href="#使用-p2sh-实现多重签名的实际例子" class="header-anchor">#</a> 使用 P2SH 实现多重签名的实际例子</h4> <p><img src="/coin-notes/assets/img/ins_four.78212ed8.png" alt="Merkle proof"></p> <p>交易的哈希：bc26380619a36e0ecbb5bae4eebf78d8fdef24ba5ed5fd040e7bff37311e180d</p> <h3 id="proof-of-burn"><a href="#proof-of-burn" class="header-anchor">#</a> Proof of Burn</h3> <p><img src="/coin-notes/assets/img/proof_of_burn.915c56c5.png" alt="Merkle proof"></p> <p>在输出脚本中有 <code>RETURN</code> 命令时，脚本执行永远会返回 FALSE ， <code>RETURN</code> 命令是证明销毁比特币的方法。</p> <p>实际中的主要应用场景有两个：</p> <ol><li>一些小币种要求必须销毁一定的比特币才能得到相应的虚拟币</li> <li>向区块链中写入一些不可篡改的内容</li></ol> <h3 id="吐槽"><a href="#吐槽" class="header-anchor">#</a> 吐槽</h3> <p>个人觉得这些脚本名字都是 <code>Pay to xxx</code> 这种形式不太好，而改成 <code>从...收款</code> 更好一点，因为这些脚本的含义就是验证从 <code>output script</code> 到 <code>input script</code> 的交易，而不是在做支付操作，使用 <code>Pay to xxx</code> 怪怪的。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/coin-notes/btc/btc08.html" class="prev">
        08 - BTC-挖矿
      </a></span> <span class="next"><a href="/coin-notes/btc/btc10.html">
        10 - BTC-分叉
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/coin-notes/assets/js/app.3ac0d405.js" defer></script><script src="/coin-notes/assets/js/2.05c3ac16.js" defer></script><script src="/coin-notes/assets/js/3.67cf15e5.js" defer></script>
  </body>
</html>
